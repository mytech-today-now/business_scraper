<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Yelp Directory URL Skipping Fix - Business Scraper Documentation</title>
    <link rel="stylesheet" href="style.css" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css"
    />
  </head>
  <body>
    <div class="content-wrapper">
      <div class="back-to-docs">
        <a href="readme.html" class="btn btn-outline-primary"> ‚Üê Back to Documentation Hub </a>
      </div>

      <div class="nav-breadcrumb">
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb mb-0">
            <li class="breadcrumb-item">
              <a href="readme.html">Documentation</a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">
              Yelp Directory URL Skipping Fix
            </li>
          </ol>
        </nav>
      </div>

      <main class="documentation-content">
        <h1>Yelp Directory URL Skipping Fix</h1>
        <h2>Issue Description</h2>
        <p>The application was generating warning messages like:</p>
        <pre><code>[09:04:47 PM] &lt;ScraperController&gt; WARN: Skipping directory/search page: https://www.yelp.com/search?cflt=architects&amp;find_loc=Barrington%2C+IL+60010
</code></pre>
        <h2>Root Cause Analysis</h2>
        <p>
          The issue was caused by
          <strong>directory search URLs being returned as business websites</strong> to scrape,
          which is incorrect behavior. Here&#39;s what was happening:
        </p>
        <h3>1. <strong>Incorrect URL Generation</strong></h3>
        <p>
          The <code>generateAlternativeBusinessSearches()</code> function in
          <code>/api/search/route.ts</code> was creating directory search URLs as fallback results
          when primary search methods didn&#39;t return enough business websites.
        </p>
        <pre><code class="language-typescript">// PROBLEMATIC CODE (now fixed)
const businessDirectories = [
  {
    name: &#39;Yelp&#39;,
    domain: &#39;yelp.com&#39;,
    url: `https://www.yelp.com/search?find_desc=${encodeURIComponent(query)}&amp;find_loc=${encodeURIComponent(location)}`
  },
  // ... other directories
]
</code></pre>
        <h3>2. <strong>Correct Detection and Skipping</strong></h3>
        <p>
          The <code>isDirectoryOrSearchPage()</code> function in
          <code>useScraperController.ts</code> was correctly identifying these URLs as directory
          pages and skipping them:
        </p>
        <pre><code class="language-typescript">// This function was working CORRECTLY
function isDirectoryOrSearchPage(url: string): boolean {
  const directorySites = [&#39;yelp.com&#39;, &#39;yellowpages.com&#39;, &#39;bbb.org&#39;, ...]
  const searchPatterns = [&#39;/search&#39;, &#39;find_desc=&#39;, &#39;find_loc=&#39;, ...]
  
  // Correctly identifies Yelp search URLs as directory pages
  return directorySites.some(site =&gt; hostname.includes(site)) ||
         searchPatterns.some(pattern =&gt; pathname.includes(pattern) || search.includes(pattern))
}
</code></pre>
        <h3>3. <strong>The Problem</strong></h3>
        <p>
          Directory search URLs should <strong>never be returned as business websites</strong> in
          the first place. They should only be used as a conduit to find actual business websites.
        </p>
        <h2>Solution Implemented</h2>
        <h3>1. <strong>Removed Directory URL Generation</strong></h3>
        <p>Updated <code>generateAlternativeBusinessSearches()</code> to return an empty array:</p>
        <pre><code class="language-typescript">function generateAlternativeBusinessSearches(query: string, location: string, maxResults: number): any[] {
  // Return empty array - directory search URLs should not be returned as business websites
  // The proper approach is to use dedicated discovery services (Yelp Discovery, BBB Discovery)
  // that extract actual business websites from directory pages
  logger.info(&#39;Search API&#39;, `Not generating directory search URLs as business results for ${query} in ${location}`)
  return []
}
</code></pre>
        <h3>2. <strong>Removed Fallback Calls</strong></h3>
        <p>
          Cleaned up all calls to <code>generateAlternativeBusinessSearches()</code> since it now
          returns empty arrays:
        </p>
        <p><strong>Before:</strong></p>
        <pre><code class="language-typescript">if (uniqueResults.length &lt; maxResults) {
  const alternativeSearches = generateAlternativeBusinessSearches(query, location, maxResults - uniqueResults.length)
  uniqueResults.push(...alternativeSearches)
}
</code></pre>
        <p><strong>After:</strong></p>
        <pre><code class="language-typescript">// Note: No longer adding directory search URLs as business results
// Use dedicated discovery services (Yelp Discovery, BBB Discovery) instead
</code></pre>
        <h3>3. <strong>Proper Error Handling</strong></h3>
        <p>When BBB scraping fails, return an error instead of directory URLs:</p>
        <p><strong>Before:</strong></p>
        <pre><code class="language-typescript">const fallbackResults = generateAlternativeBusinessSearches(query, location, maxResults)
// Add BBB search URL as fallback...
</code></pre>
        <p><strong>After:</strong></p>
        <pre><code class="language-typescript">return NextResponse.json(
  {
    success: false,
    error: &#39;BBB business discovery failed and no fallback available&#39;,
    provider: &#39;bbb-discovery&#39;,
    query: query,
    location: location,
    results: [],
    count: 0
  },
  { status: 500 }
)
</code></pre>
        <h2>Correct Architecture</h2>
        <h3>‚úÖ <strong>Proper Approach</strong></h3>
        <ol>
          <li>
            <strong>Discovery Services</strong>: Use dedicated services like
            <code>yelpScrapingService</code> and <code>bbbScrapingService</code>
          </li>
          <li>
            <strong>Extract Real URLs</strong>: These services navigate to directory pages and
            extract actual business websites
          </li>
          <li>
            <strong>Scrape Business Sites</strong>: Only scrape the extracted business websites,
            never the directory pages
          </li>
        </ol>
        <h3>‚ùå <strong>Incorrect Approach (Fixed)</strong></h3>
        <ol>
          <li><del>Return directory search URLs as business results</del></li>
          <li><del>Attempt to scrape directory pages</del></li>
          <li><del>Generate warnings when correctly skipping directory pages</del></li>
        </ol>
        <h2>Data Flow After Fix</h2>
        <h3>1. <strong>Search Request</strong></h3>
        <pre><code>User searches for &quot;architects&quot; in &quot;Barrington, IL 60010&quot;
</code></pre>
        <h3>2. <strong>Discovery Process</strong></h3>
        <pre><code>Yelp Discovery Service:
1. Navigate to: https://www.yelp.com/search?find_desc=architects&amp;find_loc=Barrington%2C+IL+60010
2. Extract business profile URLs from YERP (Yelp Engine Results Page)
3. Visit each business profile page
4. Extract actual business website URLs (e.g., www.architectfirm.com)
5. Return only real business websites
</code></pre>
        <h3>3. <strong>Scraping Process</strong></h3>
        <pre><code>Scraper Controller:
1. Receives real business websites (e.g., www.architectfirm.com)
2. Validates URLs (passes isDirectoryOrSearchPage check)
3. Scrapes business websites for contact information
4. No warnings about directory pages
</code></pre>
        <h2>Benefits of the Fix</h2>
        <h3>üéØ <strong>Eliminates Warnings</strong></h3>
        <ul>
          <li>No more &quot;Skipping directory/search page&quot; warnings</li>
          <li>Cleaner log output</li>
          <li>Better user experience</li>
        </ul>
        <h3>üìä <strong>Improves Data Quality</strong></h3>
        <ul>
          <li>Only real business websites are processed</li>
          <li>No wasted processing on directory pages</li>
          <li>More accurate business contact information</li>
        </ul>
        <h3>‚ö° <strong>Better Performance</strong></h3>
        <ul>
          <li>No unnecessary attempts to scrape directory pages</li>
          <li>Faster processing with fewer failed attempts</li>
          <li>More efficient resource utilization</li>
        </ul>
        <h3>üîß <strong>Cleaner Architecture</strong></h3>
        <ul>
          <li>Clear separation between discovery and scraping</li>
          <li>Proper use of dedicated discovery services</li>
          <li>No mixing of directory URLs with business URLs</li>
        </ul>
        <h2>Testing the Fix</h2>
        <h3>1. <strong>Search for Businesses</strong></h3>
        <pre><code>Query: &quot;architects&quot; 
Location: &quot;Barrington, IL 60010&quot;
</code></pre>
        <h3>2. <strong>Expected Behavior</strong></h3>
        <ul>
          <li>‚úÖ No warnings about skipping Yelp search URLs</li>
          <li>‚úÖ Only real business websites in results</li>
          <li>‚úÖ Successful scraping of business contact information</li>
          <li>‚úÖ Clean log output</li>
        </ul>
        <h3>3. <strong>Verification</strong></h3>
        <p>Check the browser console and application logs:</p>
        <ul>
          <li>Should see: <code>&quot;Yelp discovery returned X business websites&quot;</code></li>
          <li>
            Should NOT see:
            <code>&quot;Skipping directory/search page: https://www.yelp.com/search...&quot;</code>
          </li>
        </ul>
        <h2>Related Components</h2>
        <h3><strong>Fixed Files:</strong></h3>
        <ul>
          <li><code>src/app/api/search/route.ts</code> - Removed directory URL generation</li>
          <li><code>YELP_RESTFUL_SCRAPING.md</code> - Updated documentation</li>
        </ul>
        <h3><strong>Unchanged (Working Correctly):</strong></h3>
        <ul>
          <li><code>src/controller/useScraperController.ts</code> - Directory detection logic</li>
          <li><code>src/lib/yelpScrapingService.ts</code> - RESTful Yelp scraping</li>
          <li><code>src/lib/bbbScrapingService.ts</code> - BBB discovery service</li>
        </ul>
        <h2>Summary</h2>
        <p>
          The fix ensures that
          <strong>directory search URLs are never returned as business websites</strong> to scrape.
          Instead, the application properly uses dedicated discovery services that:
        </p>
        <ol>
          <li><strong>Navigate to directory pages</strong> (Yelp, BBB, etc.)</li>
          <li><strong>Extract actual business websites</strong> from those pages</li>
          <li><strong>Return only real business URLs</strong> for scraping</li>
        </ol>
        <p>
          This eliminates the warnings and provides a cleaner, more efficient scraping process that
          focuses on actual business websites rather than directory pages.
        </p>
      </main>

      <footer class="text-center mt-5 pt-4 border-top">
        <p class="text-muted">
          <strong>Business Scraper Application v3.0.0</strong> - Enterprise Multi-User Collaboration
          Platform
        </p>
        <p class="text-muted">
          <a href="readme.html">Documentation Hub</a> |
          <a href="https://github.com/mytech-today-now/business_scraper">GitHub Repository</a>
        </p>
        <p class="text-muted small">Last updated: 8/24/2025</p>
      </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
  </body>
</html>
